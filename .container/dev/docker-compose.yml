services:
  # Coordinator Service
  coordinator:
    build:
      context: ../..
      dockerfile: .container/dev/Dockerfile.nodejs
    container_name: dev-coordinator
    hostname: coordinator
    working_dir: /workspace
    command: >
      sh -c "pnpm --filter coordinator dev"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PROCESS_NAME=coordinator
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=${COORDINATOR_PORT:-3500}
      - SHARD_COORDINATOR_BIND_PORT=${SHARD_COORDINATOR_BIND_PORT:-5555}
      - SHARD_COORDINATOR_BIND_HOST=${SHARD_COORDINATOR_BIND_HOST:-tcp://0.0.0.0}
      - HEARTBEAT_TIMEOUT_SECONDS=${HEARTBEAT_TIMEOUT_SECONDS:-15}
      - HEARTBEAT_CHECK_INTERVAL_SECONDS=${HEARTBEAT_CHECK_INTERVAL_SECONDS:-5}
    ports:
      - "${COORDINATOR_PORT:-3500}:${COORDINATOR_PORT:-3500}"
      - "${SHARD_COORDINATOR_BIND_PORT:-5555}:${SHARD_COORDINATOR_BIND_PORT:-5555}"
    volumes:
      - ../..:/workspace
    networks:
      - dev-network
    restart: unless-stopped

  # External Bridge - Fetcher Binance
  external-bridge-binance-fetcher:
    build:
      context: ../..
      dockerfile: .container/dev/Dockerfile.nodejs
    container_name: dev-external-bridge-binance-fetcher
    hostname: fetcher-binance
    working_dir: /workspace
    command: >
      sh -c "pnpm --filter external-bridge dev:fetcher-binance"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PROCESS_NAME=external-bridge-binance-fetcher
      - PLATFORM=binance
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=${EXTERNAL_BRIDGE_FETCHER_BINANCE_PORT:-3000}
      - STORAGE_BASE_DIR=${STORAGE_BASE_DIR:-/data/storage}
    ports:
      - "${EXTERNAL_BRIDGE_FETCHER_BINANCE_PORT:-3000}:${EXTERNAL_BRIDGE_FETCHER_BINANCE_PORT:-3000}"
    volumes:
      - ../..:/workspace
      - ../../storage:/data/storage
    networks:
      - dev-network
    restart: unless-stopped

  # External Bridge - Fetcher Kraken
  external-bridge-kraken-fetcher:
    build:
      context: ../..
      dockerfile: .container/dev/Dockerfile.nodejs
    container_name: dev-external-bridge-kraken-fetcher
    hostname: fetcher-kraken
    working_dir: /workspace
    command: >
      sh -c "pnpm --filter external-bridge dev:fetcher-kraken"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PROCESS_NAME=external-bridge-kraken-fetcher
      - PLATFORM=kraken
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=${EXTERNAL_BRIDGE_FETCHER_KRAKEN_PORT:-3001}
      - STORAGE_BASE_DIR=${STORAGE_BASE_DIR:-/data/storage}
    ports:
      - "${EXTERNAL_BRIDGE_FETCHER_KRAKEN_PORT:-3001}:${EXTERNAL_BRIDGE_FETCHER_KRAKEN_PORT:-3001}"
    volumes:
      - ../..:/workspace
      - ../../storage:/data/storage
    networks:
      - dev-network
    restart: unless-stopped

  # External Bridge - WebSocket Binance
  external-bridge-binance-websocket:
    build:
      context: ../..
      dockerfile: .container/dev/Dockerfile.nodejs
    container_name: dev-external-bridge-binance-websocket
    hostname: websocket-binance
    working_dir: /workspace
    command: >
      sh -c "pnpm --filter external-bridge dev:websocket-binance"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PROCESS_NAME=external-bridge-binance-websocket
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=${EXTERNAL_BRIDGE_WEBSOCKET_BINANCE_PORT:-3100}
      - STORAGE_BASE_DIR=${STORAGE_BASE_DIR:-/data/storage}
    ports:
      - "${EXTERNAL_BRIDGE_WEBSOCKET_BINANCE_PORT:-3100}:${EXTERNAL_BRIDGE_WEBSOCKET_BINANCE_PORT:-3100}"
    volumes:
      - ../..:/workspace
      - ../../storage:/data/storage
    networks:
      - dev-network
    restart: unless-stopped

  # External Bridge - WebSocket Kraken
  external-bridge-kraken-websocket:
    build:
      context: ../..
      dockerfile: .container/dev/Dockerfile.nodejs
    container_name: dev-external-bridge-kraken-websocket
    hostname: websocket-kraken
    working_dir: /workspace
    command: >
      sh -c "pnpm --filter external-bridge dev:websocket-kraken"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PROCESS_NAME=external-bridge-kraken-websocket
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=${EXTERNAL_BRIDGE_WEBSOCKET_KRAKEN_PORT:-3101}
      - STORAGE_BASE_DIR=${STORAGE_BASE_DIR:-/data/storage}
    ports:
      - "${EXTERNAL_BRIDGE_WEBSOCKET_KRAKEN_PORT:-3101}:${EXTERNAL_BRIDGE_WEBSOCKET_KRAKEN_PORT:-3101}"
    volumes:
      - ../..:/workspace
      - ../../storage:/data/storage
    networks:
      - dev-network
    restart: unless-stopped

  # External Bridge - Storage
  external-bridge-storage:
    build:
      context: ../..
      dockerfile: .container/dev/Dockerfile.nodejs
    container_name: dev-external-bridge-storage
    hostname: storage
    working_dir: /workspace
    command: >
      sh -c "pnpm --filter external-bridge dev:storage"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PROCESS_NAME=external-bridge-storage
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PORT=${EXTERNAL_BRIDGE_STORAGE_PORT:-3200}
      - STORAGE_BASE_DIR=${STORAGE_BASE_DIR:-/data/storage}
    ports:
      - "${EXTERNAL_BRIDGE_STORAGE_PORT:-3200}:${EXTERNAL_BRIDGE_STORAGE_PORT:-3200}"
    volumes:
      - ../..:/workspace
      - ../../storage:/data/storage
    networks:
      - dev-network
    restart: unless-stopped

  # Perses Dashboard
  perses:
    build:
      context: .
      dockerfile: Dockerfile.perses
    container_name: dev-perses
    hostname: perses
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${PERSES_PORT:-8080}
    ports:
      - "${PERSES_PORT:-8080}:8080"
    volumes:
      - ../../runtime/monitoring-perses/config.yml:/etc/perses/config.yml:ro
      - ../../storage/perses:/data/perses
      - ../../runtime/monitoring-perses/data:/app/data
    networks:
      - dev-network
    restart: unless-stopped

  # VictoriaMetrics
  victoriametrics:
    build:
      context: .
      dockerfile: Dockerfile.victoriametrics
    container_name: dev-victoriametrics
    hostname: victoriametrics
    command:
      - -storageDataPath=/data/victoria_metrics
      - -retentionPeriod=${RETENTION_PERIOD:-12}
      - -httpListenAddr=:8428
      - -promscrape.config=/etc/prometheus/prometheus.yml
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - GOMAXPROCS=${GOMAXPROCS:-2}
      - PORT=${VICTORIA_METRICS_PORT:-8428}
    ports:
      - "${VICTORIA_METRICS_PORT:-8428}:8428"
    volumes:
      - ../../storage/victoria_metrics:/data/victoria_metrics
      - ../../runtime/monitoring-victoria-metrics/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - dev-network
    restart: unless-stopped

networks:
  dev-network:
    driver: bridge


